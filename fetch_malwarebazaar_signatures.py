import requests
import zipfile
import io
from constants import IOCS_DIR_PATH
import os
from remote_logging import do_remote_logging
import csv
import codecs

# BESIDES LOKI IN-HOUSE DATABASE SIGNATURE UPDATES, WE CAN ALSO RELY ON EXTERNAL SOURCES
# E.G. MALWAREBAZAAR PROVIDES HOURLY UPDATES OF SHA256 HASHES OF NEWLY SUBMITTED MALWARE
# HENCE WE CAN OBTAIN THEIR HASHES TO MITIGATE THE LACK OF SIGNATURES WITHIN LOKI

# IN THIS CASE, NO API KEY IS REQUIRED FOR MALWAREBAZAAR'S HASHES

# MALWAREBAZAAR ALSO HAS A CODE SIGNING CERTIFICATE BLOCKLIST (CSCB) WHICH CONTAINS THE CODE SIGNING CERTIFICATES
# USED BY MALWARE AUTHORS TO SIGN PORTABLE EXECUTABLES (PEs)
# HENCE CAN ENHANCE SIGNATURE-BASED DETECTION WITH THE ADDITION OF CSCB

MALWAREBAZAAR_SHA256_URL = "https://bazaar.abuse.ch/export/txt/sha256/full/"
MALWAREBAZAAR_UNPROCESSED_HASH_FILE_NAME = "full_sha256.txt" # this must match the file name in the zip file obtained from MalwareBazaar
MALWAREBAZAAR_PROCESSED_HASH_FILE_NAME = "malwarebazaar-hash-iocs.txt"
MALWAREBAZAAR_CODE_SIGNING_CERTIFICATE_BLOCKLIST_URL = "https://bazaar.abuse.ch/export/csv/cscb/"
MALWAREBAZAAR_UNPROCESSED_BLOCKLIST_FILE_NAME = "code_signing.csv"
MALWAREBAZAAR_PROCESSED_BLOCKLIST_FILE_NAME = "codesign-iocs.txt"


# To fetch ZIP file of SHA256 malware hashes from MalwareBazaar
def fetch_malwarebazaar_hashes(logger, remote_logger):
    try:
        logger.log("INFO", "External-Upgrader", "Downloading %s ..." % MALWAREBAZAAR_SHA256_URL)
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Downloading %s ..." % MALWAREBAZAAR_SHA256_URL])
        sha256_file = requests.get(MALWAREBAZAAR_SHA256_URL)
        sha256_zip = zipfile.ZipFile(io.BytesIO(sha256_file.content))
        try:
            os.remove(os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_UNPROCESSED_HASH_FILE_NAME))
        except:
            pass
        sha256_unzipped = sha256_zip.extractall(IOCS_DIR_PATH)
        return True
    except:
        logger.log("ERROR", "External-Upgrader", "Error while downloading %s ..." % MALWAREBAZAAR_SHA256_URL)
        do_remote_logging(remote_logger, "ERROR", ["External-Upgrader", "Error while downloading %s ..." % MALWAREBAZAAR_SHA256_URL])
        return False

# To parse the downloaded file and format it for successful loading by MALLEVEL scanner (hash;comment)
def process_malwarebazaar_hashes(logger, remote_logger):
    comment = "MalwareBazaar SHA256 Hash"
    original_hash_ioc_file = os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_UNPROCESSED_HASH_FILE_NAME)
    new_hash_ioc_file = os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_PROCESSED_HASH_FILE_NAME)
    try:
        logger.log("INFO", "External-Upgrader", "Processing MalwareBazaar SHA256 hashes...")
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Processing MalwareBazaar SHA256 hashes..."])
        with codecs.open(original_hash_ioc_file, 'r', encoding='utf-8') as file_1, codecs.open(new_hash_ioc_file, 'w', encoding='utf-8') as file_2:
            lines = file_1.readlines()
            for line in lines:
                if line.startswith("#") == False:
                    new_line = "%s;%s\n" % (line.rstrip('\r\n'), comment)
                    file_2.write(new_line)
        logger.log("INFO", "External-Upgrader", "Finished processing MalwareBazaar SHA256 hashes...")
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Finished processing MalwareBazaar SHA256 hashes..."])        
    except:
        logger.log("ERROR", "External-Upgrader", "Error while processing MalwareBazaar SHA256 hashes...")
        do_remote_logging(remote_logger, "ERROR", ["External-Upgrader", "Error while processing MalwareBazaar SHA256 hashes..."])
        pass
    try:
        os.remove(original_hash_ioc_file)
    except:
        pass

# To fetch CSV file of code signing certificates blocklist from MalwareBazaar, and parse it for successful loading by MALLEVEL scanner.
def fetch_malwarebazaar_code_signing_certificate_blocklist(logger, remote_logger):
    # Download CSV from Blocklist URL
    try:
        with requests.get(MALWAREBAZAAR_CODE_SIGNING_CERTIFICATE_BLOCKLIST_URL) as blocklist:
            with open(os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_UNPROCESSED_BLOCKLIST_FILE_NAME), "wb") as blocklist_csv:
                for chunk in blocklist.iter_content(chunk_size=8192): 
                    blocklist_csv.write(chunk)
        logger.log("INFO", "External-Upgrader", "Downloading %s ..." % MALWAREBAZAAR_CODE_SIGNING_CERTIFICATE_BLOCKLIST_URL)
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Downloading %s ..." % MALWAREBAZAAR_CODE_SIGNING_CERTIFICATE_BLOCKLIST_URL])
        return True
    except:
        logger.log("ERROR", "External-Upgrader", "Error while fetching MalwareBazaar Code Signing Certificate Blocklist (CSCB)...")
        do_remote_logging(remote_logger, "ERROR", ["External-Upgrader", "Error while fetching MalwareBazaar Code Signing Certificate Blocklist (CSCB)..."])
        return False
    
def process_malwarebazaar_code_signing_certificate_blocklist(logger, remote_logger):    
    # Parse CSV into text file with only important information (Serial No. and Comment)
    try:
        logger.log("INFO", "External-Upgrader", "Processing MalwareBazaar Code Signing Certificate Blocklist (CSCB)...")
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Processing MalwareBazaar Code Signing Certificate Blocklist (CSCB)..."])
        with codecs.open(os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_UNPROCESSED_BLOCKLIST_FILE_NAME), 'r', encoding = 'cp850') as code_signing_blocklist:
            code_signing_dict = csv.reader(filter(lambda row: row[0]!='#', code_signing_blocklist))
            with codecs.open(os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_PROCESSED_BLOCKLIST_FILE_NAME), 'w', encoding='utf-8') as blocklist_file:
                for code_signing_data in code_signing_dict:
                    try:
                        serial_number = code_signing_data[1].replace('"', '').replace(" ", '') # The second column of the CSV file contains the serial numbers of the blocked certificates
                        comment = code_signing_data[-1].replace('"', '').replace(" ", '') # The lastcolumn of the CSV file contains the reasons for blocking the certificates
                        if serial_number != "serial_number": # Do not write the column labels to the IOCs file
                            blocklist_file.write("%s;%s\n" % (serial_number, comment))
                    except:
                        pass
        logger.log("INFO", "External-Upgrader", "Finished writing MalwareBazaar Code Signing Certificate Blocklist (CSCB) to %s" % MALWAREBAZAAR_PROCESSED_BLOCKLIST_FILE_NAME)
        do_remote_logging(remote_logger, "INFO", ["External-Upgrader", "Finished writing MalwareBazaar Code Signing Certificate Blocklist (CSCB) to %s" % MALWAREBAZAAR_PROCESSED_BLOCKLIST_FILE_NAME])        
    except:
        logger.log("ERROR", "External-Upgrader", "Error while processing MalwareBazaar Code Signing Certificate Blocklist (CSCB)...")
        do_remote_logging(remote_logger, "ERROR", ["External-Upgrader", "Error while processing MalwareBazaar Code Signing Certificate Blocklist (CSCB)..."])
    try:
        os.remove(os.path.join(IOCS_DIR_PATH, MALWAREBAZAAR_UNPROCESSED_BLOCKLIST_FILE_NAME))
    except:
        pass

if __name__=='__main__':
    fetch_malwarebazaar_code_signing_certificate_blocklist(None, None)
    process_malwarebazaar_code_signing_certificate_blocklist(None, None)